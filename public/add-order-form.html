<dom-module id="add-order-form">
    <style>
        iron-icon {
            color: #3F51B5;
        }

        form > paper-button:not([disabled]) {
            background: var(--primary-background-color);
            color: white;
        }

        h2 {
            border-bottom: 1px solid #f50057;
            margin: 20px 0;
        }

        .yellow-button {
            text-transform: none;
            color: #eeff41;
        }

        .success-toast {
            background-color: var(--primary-background-color);
            color: white;
        }

        .error-toast {
            background-color: red;
            color: white;
        }

        paper-spinner {
            padding-left: 15px;
        }
    </style>
    <template>
        <h2 id="event-listeners" class="has-permalink">Add new order</h2>
        <!--  <iron-ajax
                  id="getDrinksAjax"
                  url="/rest/v1.0/drink"
                  handle-as="json"
                  on-response="processDrinkTypes"></iron-ajax>-->
        <form is="iron-form" id="addItemForm" on-change="_onFormChanged">
            <label id="typeSelectLabel"> Type of Drink:</label>
            <!--TODO: add image of drink here, seperate tea and coffe -->
            <paper-radio-group on-iron-select="_onTypeSelected" selected="{{name}}"
                               aria-labelledby="typeSelectLabel" fallbackSelection
                               id="typeSelect" required>
                <template is="dom-repeat" items='{{names}}'>
                    <paper-radio-button name="{{item}}">{{item}}</paper-radio-button>
                </template>
            </paper-radio-group>

            <br>
            <label id="sizeLabel">Size: </label>
            <paper-radio-group id="sizeSelect" on-iron-items-changed="_onSizesChanged" on-iron-select="_onFormChanged"
                               selected="{{size}}" ria-labelledby="sizeLabel" required>
                <template is="dom-repeat" items='{{sizes}}'>
                    <paper-radio-button name="{{item}}">{{item}}</paper-radio-button>
                </template>
            </paper-radio-group>
            <!--TODO: add image of drink size here-->
            <br>
            <div class="layout horizontal center">
                <paper-input required label="Quantity" min="1" type="number" on-change="_onFormChanged"
                             value="{{quantity}}"></paper-input>

                <paper-icon-button on-tap="increaseQuantity" icon="icons:add-circle-outline"
                                   title="increase">
                </paper-icon-button>
                <paper-icon-button on-tap="decreaseQuantity" icon="icons:remove-circle-outline"
                                   title="decrease">
                </paper-icon-button>
                <br>
            </div>
            <div class="layout horizontal">
                <paper-input required label="Price Unit" min="0" type="number" readonly
                             value="{{price}}"></paper-input>
            </div>
            <br>
            <div class="layout horizontal">
                <paper-input required autoValidate label="Total" min="0" type="number" readonly
                             value="{{total}}"></paper-input>
            </div>
            <br>
            <paper-button disabled raised on-tap="addItem" id="submitItemButton" disabled$="{{submitting}}">Add
                <paper-spinner id="spinner" active="{{submitting}}" hidden$="{{!submitting}}"></paper-spinner>
            </paper-button>
            <paper-button raised on-tap="resetItem" disabled$="{{submitting}}">Reset</paper-button>
            <iron-ajax id="addItemAjax" content-type="application/json" handle-as="json"
                       url="/rest/v1.0/order" method="PUT" body="{{params}}" on-error="_onAddOrderError"
                       on-response="_onAddOrderResponse">
            </iron-ajax>
            {{toastClass}}
            <paper-toast id="toast" duration="10000" class="fit-bottom" text="{{toast}}">
                <paper-button onclick="toast.toggle()" class="yellow-button">Close</paper-button>
            </paper-toast>
        </form>
    </template>
    <script>
        "useStrict"
        Polymer({
            is: 'add-order-form',
            properties: {
                params: {
                    type: Object,
                    computed: '_computeParams(name, size, price, quantity, total)'
                },
                quantity: {
                    type: Number,
                    value: 1
                },
                submitting: {
                    type: Boolean,
                    value: false
                },
                drinks: {
                    type: Array,
                    observer: "processDrinkTypes"
                }
            },
            init: function () {
                /* send ajax to get all drinks type only the first time*/
                if (_.size(this.drinks) == 0) {
                    getDrinksAjax.generateRequest();
                }
            },
            _computeParams: function (name, size, price, quantity, total) {
                return {
                    name: name,
                    size: size,
                    type: this.type,
                    price: price,
                    quantity: quantity,
                    amount: total
                };
            },
            _onAddOrderError: function (e) {
                toast.classList.remove("success-toast");
                toast.classList.add("error-toast");
                this.submitting = false;
                toast.show({text: "An error occurred on the server when adding new order: " + _.get(e, "detail.request.response.message", "")});
            },
            _onAddOrderResponse: function (e) {
                this.submitting = false;
                toast.classList.remove("error-toast");
                toast.classList.add("success-toast");
                toast.show({text: "Order added successfully!"});
            },
            processDrinkTypes: function () {
                this.names = _.uniq(_.map(this.drinks, 'name'));
                this.name = this.names[0];
            },
            resetItem: function () {
                addItemForm.reset();
                this.name = undefined;
                this.size = undefined;
                this.toggleSubmit(true);
            },
            addItem: function (e) {
                this.submitting = true;
                addItemAjax.generateRequest();
            },
            _onTypeSelected: function () {
                console.log("_onTypeSelected");
                this.sizes = _.map(_.filter(this.drinks, ['name', this.name]), 'size');
            },
            _onSizesChanged: function () {
                //if none selected or selected is not included in current selectables --> select first one
                if (!_.isUndefined(this.sizes) && ( _.isUndefined(this.size) || !_.includes(this.sizes, this.size)))
                    this.size = this.sizes[0];
            },
            _onFormChanged: function () {
                console.log("_onFormChanged");
                if (!_.isUndefined(this.name) && !_.isUndefined(this.size)) {
                    var drink = _.find(this.drinks, {
                        'name': this.name,
                        'size': this.size
                    });
                    this.price = drink.price;
                    this.type = drink.type;
                    // keep the precision to 2 decimals
                    this.total = (drink.price * this.quantity ).toFixed(2);
                    this.toggleSubmit(false);
                } else {
                    this.drink = {};
                    this.price = '';
                    this.total = '';
                    this.toggleSubmit(true);
                }
            },
            increaseQuantity: function (amount) {
                this.quantity++;
                this._onFormChanged();
            },
            decreaseQuantity: function (amount) {
                this.quantity = this.quantity <= 1 ? 1 : this.quantity - 1;
                this._onFormChanged();
            },
            toggleSubmit: function (flag) {
                submitItemButton.disabled = flag;
            }
        })
        ;
    </script>
</dom-module>
